<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robust Intelligence + DataRobot Integration Walkthrough &mdash; Robust Intelligence  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/nbsphinx-code-cells.css" type="text/css" />
      <link rel="stylesheet" href="https://cdn.datatables.net/v/dt/dt-1.13.1/sb-1.4.0/datatables.min.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../../_static/main.js"></script>
        <script src="https://cdn.datatables.net/v/dt/dt-1.13.1/sb-1.4.0/datatables.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Robust Intelligence ü§ù ü§ó Integration Walkthrough" href="RIME_HuggingFace_Integration_Walkthrough.html" />
    <link rel="prev" title="Robust Intelligence ü§ù DataRobot" href="../../testing_and_monitoring/integrating_mlops/platform/datarobot.html" />
<link href="../../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">
<div class="ge_header no-print">
    <a id="header-logo" href="../../index.html">
        <img src="../../_static/header-logo.png" alt="logo" />
    </a>
</div>


  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Robust Intelligence
          </a>
              <div class="version">
                2.0.0-rc.14
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Documentation Home</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../documentation_home/robust_intelligence_intro.html">What is Robust Intelligence?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation_home/get_started.html">Get Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Testing and Monitoring</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/creating_projects.html">Creating Projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/preparing_your_models_and_datasets.html">Preparing your Models and Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/validating_models.html">Validate Models with Stress Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/monitoring_models.html">Monitor Models with Continuous Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/querying_results.html">Querying Test Run Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/notifications_and_alerts.html">Notifications and Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/model_governance.html">Managing Model Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/configuring_test_runs.html">Configuring your Test Runs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing_and_monitoring/test_customization.html">Test Customization</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../testing_and_monitoring/integrating_mlops.html">Integrating with MLOps</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../testing_and_monitoring/integrating_mlops/data_integrations.html">Data Integrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../testing_and_monitoring/integrating_mlops/model_integrations.html">Model Integrations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../testing_and_monitoring/integrating_mlops/platform_integrations.html">Platform Integrations</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../testing_and_monitoring/integrating_mlops/platform/databricks.html">Robust Intelligence ü§ù Databricks</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../../testing_and_monitoring/integrating_mlops/platform/datarobot.html">Robust Intelligence ü§ù DataRobot</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Robust Intelligence + DataRobot Integration Walkthrough</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="RIME_HuggingFace_Integration_Walkthrough.html">Robust Intelligence ü§ù ü§ó Integration Walkthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing_and_monitoring/integrating_mlops/platform/mlflow.html">Robust Intelligence ü§ù MLflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../testing_and_monitoring/integrating_mlops/platform/sagemaker.html">Robust Intelligence ü§ù SageMaker</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Administration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../administration/organization_administration.html">Organization Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../administration/configuring_workspaces.html">Workspace Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../administration/security_and_compliance.html">Security and Compliance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deployment/faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/python-sdk.html">Python SDK reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/troubleshooting.html">Troubleshooting Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/model_tests_reference.html">Model Tests Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/api_changelog.html">API Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Robust Intelligence</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../testing_and_monitoring/integrating_mlops.html">Integrating with MLOps</a></li>
          <li class="breadcrumb-item"><a href="../../testing_and_monitoring/integrating_mlops/platform_integrations.html">Platform Integrations</a></li>
          <li class="breadcrumb-item"><a href="../../testing_and_monitoring/integrating_mlops/platform/datarobot.html">Robust Intelligence ü§ù DataRobot</a></li>
      <li class="breadcrumb-item active">Robust Intelligence + DataRobot Integration Walkthrough</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Robust-Intelligence-+-DataRobot-Integration-Walkthrough">
<h1>Robust Intelligence + DataRobot Integration Walkthrough<a class="headerlink" href="#Robust-Intelligence-+-DataRobot-Integration-Walkthrough" title="Permalink to this heading">ÔÉÅ</a></h1>
<p>You are a data scientist at a Payment Processing Company. The data science team has been tasked with implementing a Fraud Detection service and monitoring how that model performs over time. The performance of this fraud detection model directly impacts the costs of the company. In order to ensure the data science team develops the best model and the performance of this model doesn‚Äôt degrade over time, the VP of Data Science purchases the RIME platform.</p>
<p>Your team currently does all model development and serving on DataRobot‚Äôs intelligent cloud and already uses all of its MLOps tooling.</p>
<p>In this Notebook Walkthrough, we will walkthrough 2 of RIME‚Äôs core products - <strong>AI Stress Testing</strong> and <strong>AI Firewall</strong> and demonstrate how they integrate with DataRobot‚Äôs core offerings to help you develop and maintain more robust AI models.</p>
<ol class="arabic simple">
<li><p><strong>AI Stress Testing</strong> is used in the model development stage. Using AI Stress Testing you can test the developed model. RIME goes beyond simply optimizing for basic model performance like accuracy and automatically discovers the model‚Äôs weaknesses.</p></li>
<li><p><strong>AI Firewall</strong> is used after the model is deployed in production. Using AI Firewall, you can automate the monitoring, discovery and remediation of issues that occur post-deployment. Additionally it automatically flags, blocks, or imputes erroneous data in real-time.</p></li>
</ol>
<section id="Install-Dependencies,-Import-Libraries-and-Download-Data">
<h2><strong>Install Dependencies, Import Libraries and Download Data</strong><a class="headerlink" href="#Install-Dependencies,-Import-Libraries-and-Download-Data" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Run the cell below to install libraries to recieve data, install our SDK, and load analysis libraries.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> install pandas &amp;&gt; /dev/null
<span class="o">%</span><span class="k">pip</span> install datarobot &amp;&gt; /dev/null
<span class="o">%</span><span class="k">pip</span> install rime-sdk &amp;&gt; /dev/null
<span class="o">%</span><span class="k">pip</span> install https://github.com/RobustIntelligence/ri-public-examples/archive/master.zip &amp;&gt; /dev/null

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">datarobot</span> <span class="k">as</span> <span class="nn">dr</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">ri_public_examples.download_files</span> <span class="kn">import</span> <span class="n">download_files</span>

<span class="n">download_files</span><span class="p">(</span><span class="s2">&quot;tabular/fraud&quot;</span><span class="p">,</span> <span class="s2">&quot;fraud_data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Connecting-to-DataRobot">
<h2><strong>Connecting to DataRobot</strong><a class="headerlink" href="#Connecting-to-DataRobot" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>If you do not already have an account with DataRobot, create one now. Once that is done, copy your DataRobot API Key and assign to the variable <code class="docutils literal notranslate"><span class="pre">DATAROBOT_TOKEN</span></code> below.</p>
<p>See the <a class="reference external" href="https://docs.datarobot.com/en/docs/platform/account-mgmt/acct-settings/api-key-mgmt.html#api-key-management">documentation here</a> for more information on DataRobot‚Äôs API key management console.</p>
</section>
<section id="Connecting-to-RIME">
<h2><strong>Connecting to RIME</strong><a class="headerlink" href="#Connecting-to-RIME" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Next, copy your API key for RIME and assign to the variable <code class="docutils literal notranslate"><span class="pre">RIME_API_TOKEN</span></code> below.</p>
<p>You can generate a new API key within the ‚ÄòWorkspace settings‚Äô page on your RIME cluster‚Äôs website.</p>
<p>Additionally, copy the url of the cluster (e.g., ‚Äòrime.&lt;cluster-name&gt;.rime.dev‚Äô) to the <code class="docutils literal notranslate"><span class="pre">RIME_CLUSTER_URL</span></code> variable below. (Note: the cluster cannot be <code class="docutils literal notranslate"><span class="pre">localhost</span></code>)</p>
<p>Next, we will define some additional constants to help us load the correct datasets for this walkthrough.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># DataRobot User-provided Constants</span>
<span class="n">DATAROBOT_TOKEN</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="c1"># Endpoint may differ for managed cloud/on-prem/EU/etc.</span>
<span class="n">DATAROBOT_ENDPOINT</span><span class="o">=</span><span class="s2">&quot;https://app2.datarobot.com/api/v2&quot;</span>

<span class="c1"># RIME User-provided Constants</span>
<span class="n">RIME_API_TOKEN</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">RIME_CLUSTER_URL</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># e.g., &quot;rime.&lt;cluster&gt;.rime.dev&quot;</span>

<span class="c1"># DataRobot project constants</span>
<span class="n">dr_project_name</span> <span class="o">=</span> <span class="s1">&#39;Fraud Detection&#39;</span>
<span class="n">dr_project_id</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Set to your DataRobot project ID if you&#39;ve developed a project</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constants for loading the data</span>
<span class="n">label_col</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span>
<span class="n">excluded_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;preds&#39;</span><span class="p">]</span>
<span class="n">ref_file</span> <span class="o">=</span> <span class="s2">&quot;fraud_data/data/fraud_ref.csv&quot;</span>
<span class="n">eval_file</span> <span class="o">=</span> <span class="s2">&quot;fraud_data/data/fraud_eval.csv&quot;</span>
<span class="n">incremental_file</span> <span class="o">=</span> <span class="s2">&quot;fraud_data/data/fraud_incremental.csv&quot;</span>
<span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;LogLoss&#39;</span> <span class="c1"># DataRobot recommended metric</span>
<span class="n">autopilot_mode</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">AUTOPILOT_MODE</span><span class="o">.</span><span class="n">QUICK</span>

<span class="c1"># Load the data for training and evaluation</span>
<span class="n">train</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ref_file</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">excluded_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test</span>  <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">eval_file</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">excluded_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Develop-Models-using-DataRobot's-AutoPilot-Service">
<h2><strong>Develop Models using DataRobot‚Äôs AutoPilot Service</strong><a class="headerlink" href="#Develop-Models-using-DataRobot's-AutoPilot-Service" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>We have loaded the development datasets above and are ready to train a model. First, we‚Äôll define a few helper functions (not RIME-specific).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Helper Functions (Hidden)</span>
<span class="k">def</span> <span class="nf">get_model_score</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">dr</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;model_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model_number</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model_type</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;sample_pct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">sample_pct</span>

    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;metric_v&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;metric_cv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;crossValidation&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span> <span class="nf">get_train_preds</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">dr</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request and/or retrieve training predictions for a given model.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Request training predictions and get job IDs</span>
        <span class="n">pred_job</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">request_training_predictions</span><span class="p">(</span><span class="n">dr</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">DATA_SUBSET</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">pred_job</span><span class="o">.</span><span class="n">get_result_when_complete</span><span class="p">()</span><span class="o">.</span><span class="n">get_all_as_dataframe</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">preds</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># Retrieve training predictions if they were already requested</span>
        <span class="n">train_preds</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">TrainingPredictions</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">train_pred</span> <span class="ow">in</span> <span class="n">train_preds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">train_pred</span><span class="o">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="n">train_pred</span><span class="o">.</span><span class="n">data_subset</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">TrainingPredictions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">train_pred</span><span class="o">.</span><span class="n">prediction_id</span><span class="p">)</span><span class="o">.</span><span class="n">get_all_as_dataframe</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">preds</span>
</pre></div>
</div>
</div>
<section id="Create-DataRobot-Client-and-Project">
<h3><strong>Create DataRobot Client and Project</strong><a class="headerlink" href="#Create-DataRobot-Client-and-Project" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Before we train a model, we need to connect to our DataRobot account and create a new project (or connect to an existing one). Once the project is made, we can begin Autopilot to develop and select a model that performs well on the training data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To connect from a Zepl notebook:</span>
<span class="c1"># dr_client = dr.Client(token=z.getDatasource(&quot;datarobot_api&quot;)[&#39;token&#39;] , endpoint=DATAROBOT_ENDPOINT)</span>

<span class="c1"># To connect from a Jupyter notebook:</span>
<span class="n">dr_client</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">DATAROBOT_ENDPOINT</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">DATAROBOT_TOKEN</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">dr_project_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">dr_project</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="n">dr_project_name</span><span class="p">,</span> <span class="n">sourcedata</span><span class="o">=</span><span class="n">train</span><span class="p">)</span>
    <span class="n">dr_project</span><span class="o">.</span><span class="n">set_target</span><span class="p">(</span>
        <span class="n">target</span><span class="o">=</span><span class="n">label_col</span><span class="p">,</span>
        <span class="n">worker_count</span> <span class="o">=</span> <span class="s1">&#39;-1&#39;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">autopilot_mode</span>
    <span class="p">)</span>

    <span class="n">dr_project</span><span class="o">.</span><span class="n">wait_for_autopilot</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Wait for autopilot to complete</span>
    <span class="n">dr_project_id</span> <span class="o">=</span> <span class="n">dr_project</span><span class="o">.</span><span class="n">id</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">dr_project</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">Project</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">project_id</span><span class="o">=</span><span class="n">dr_project_id</span><span class="p">)</span>
<span class="n">test_dr_dataset</span> <span class="o">=</span> <span class="n">dr_project</span><span class="o">.</span><span class="n">upload_dataset</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fetch models trained on at least 60% of the uploaded dataset</span>
<span class="n">models</span> <span class="o">=</span> <span class="n">dr_project</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span>
    <span class="n">search_params</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;sample_pct__gt&#39;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="c1"># Order by AUC computed during cross-validation</span>
<span class="n">models</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">model</span><span class="p">:</span> <span class="n">get_model_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">)[</span><span class="s1">&#39;metric_cv&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Choose model with highest training AUC to evaluate on RIME</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Compute-Model-Predictions">
<h3><strong>Compute Model Predictions</strong><a class="headerlink" href="#Compute-Model-Predictions" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Now that we‚Äôve trained the model with Autopilot, let‚Äôs prepare the data and model for RIME to see how it can provide us with more in-depth information and recommendations for making our model as robust as possible.</p>
<p>First, we‚Äôll compute the model predictions for the evaluation dataset to speed up our RIME run.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_col_name</span> <span class="o">=</span> <span class="s2">&quot;pred&quot;</span>
<span class="n">predict_job</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">request_predictions</span><span class="p">(</span><span class="n">test_dr_dataset</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">predict_job</span><span class="o">.</span><span class="n">get_result_when_complete</span><span class="p">()</span>
<span class="n">test_with_preds</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">test_with_preds</span><span class="p">[</span><span class="n">pred_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;positive_probability&#39;</span><span class="p">]</span>
<span class="n">train_with_preds</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">train_with_preds</span><span class="p">[</span><span class="n">pred_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_train_preds</span><span class="p">(</span><span class="n">model</span><span class="p">)[</span><span class="s1">&#39;class_1.0&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Next, we‚Äôll deploy the model to facilitate a loose integration with RIME.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Deploy model</span>
<span class="k">def</span> <span class="nf">deploy_model</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">dr</span><span class="o">.</span><span class="n">Model</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dr</span><span class="o">.</span><span class="n">Deployment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a deployed model endpoint.&quot;&quot;&quot;</span>
    <span class="n">deployment</span> <span class="o">=</span> <span class="n">dr</span><span class="o">.</span><span class="n">Deployment</span><span class="o">.</span><span class="n">create_from_learning_model</span><span class="p">(</span>
      <span class="n">model_id</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Fraud Detection Deployment&quot;</span><span class="p">,</span>
      <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Deployed with DataRobot client&quot;</span><span class="p">)</span>

    <span class="c1"># View deployment stats</span>
    <span class="n">service_stats</span> <span class="o">=</span> <span class="n">deployment</span><span class="o">.</span><span class="n">get_service_stats</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">service_stats</span><span class="o">.</span><span class="n">metrics</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deployment</span>

<span class="n">deployment</span> <span class="o">=</span> <span class="n">deploy_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="id1">
<h3><strong>Connecting to RIME</strong><a class="headerlink" href="#id1" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Now for the fun. To connect to RIME, we use the API key and cluster URL specified above. You can generate a new API key within the ‚ÄòWorkspace settings‚Äô page on your RIME cluster‚Äôs website.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rime_sdk</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">Project</span><span class="p">,</span> <span class="n">Job</span>

<span class="n">rime_client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">RIME_CLUSTER_URL</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">RIME_API_TOKEN</span><span class="p">)</span>
<span class="n">rime_project</span> <span class="o">=</span> <span class="n">rime_client</span><span class="o">.</span><span class="n">create_project</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;DataRobot Demo&#39;</span><span class="p">,</span>
                                          <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Create an e2e RIME Demo using DataRobot.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Define-Helper-Functions">
<h3><strong>Define Helper Functions</strong><a class="headerlink" href="#Define-Helper-Functions" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Below, define functions to assist us in: - creating a <code class="docutils literal notranslate"><span class="pre">model.py</span></code> file that connects with the model endpoint deployed above. - uploading the model and data to the RIME cluster. - configuring the RIME run and initializing stress testing.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#@title Helper Functions</span>
<span class="k">def</span> <span class="nf">get_model_file_contents</span><span class="p">(</span><span class="n">deployment</span><span class="p">:</span> <span class="n">dr</span><span class="o">.</span><span class="n">Deployment</span><span class="p">,</span> <span class="n">api_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the stringified model.py file.&quot;&quot;&quot;</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="n">deployment</span><span class="o">.</span><span class="n">default_prediction_server</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
    <span class="n">deployment_id</span> <span class="o">=</span> <span class="n">deployment</span><span class="o">.</span><span class="n">id</span>
    <span class="n">file_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\&quot;\&quot;\&quot;</span><span class="s2">Template for how you can use RIME for a model hosted on DataRobot.</span>

<span class="s2">We expect this file to contain a `predict_dict` function that takes in a mapping from</span>
<span class="s2">feature name to feature value. This corresponds to one row in the dataset. This</span>
<span class="s2">method should return a score between 0 and 1.</span>


<span class="s2">This specific file implements this assuming that 1) your model is hosted</span>
<span class="s2">on DataRobot, and 2), that your machine is authenticated with Google Cloud,</span>
<span class="s2">and 3) that you have the requests library installed.</span>

<span class="se">\&quot;\&quot;\&quot;</span>

<span class="s2">import time</span>

<span class="s2">import numpy as np</span>
<span class="s2">import pandas as pd</span>
<span class="s2">import requests</span>


<span class="s2"># Step 1: Define endpoint variables.</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">file_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;API_URL = &quot;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s1">/predApi/v1.0/deployments&quot;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">file_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;API_KEY = &#39;</span><span class="si">{</span><span class="n">api_token</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">file_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;DEPLOYMENT_ID = &#39;</span><span class="si">{</span><span class="n">deployment_id</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">file_str</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">URL = API_URL + f&quot;/</span><span class="si">{DEPLOYMENT_ID}</span><span class="s2">/predictions&quot;</span>
<span class="s2">HEADERS = {</span>
<span class="s2">        &#39;Content-Type&#39;: &#39;application/json; charset=UTF-8&#39;,</span>
<span class="s2">        &#39;Authorization&#39;: &#39;Bearer </span><span class="si">{}</span><span class="s2">&#39;.format(API_KEY),</span>
<span class="s2">    }</span>

<span class="s2">MAX_PREDICTION_FILE_SIZE_BYTES = 52428800  # 50 MB</span>


<span class="s2">def predict_df(df: pd.DataFrame) -&gt; np.ndarray:</span>
<span class="s2">    </span><span class="se">\&quot;\&quot;\&quot;</span><span class="s2">Return array of probabilities assigned to the positive class.</span><span class="se">\&quot;\&quot;\&quot;</span>
<span class="s2">    data = pd.DataFrame.to_json(df, orient=&quot;records&quot;)</span>
<span class="s2">    # breakpoint()</span>
<span class="s2">    headers = {</span>
<span class="s2">        &quot;Content-Type&quot;: &quot;application/json; charset=UTF-8&quot;,</span>
<span class="s2">        &quot;Authorization&quot;: &quot;Bearer </span><span class="si">{}</span><span class="s2">&quot;.format(API_KEY),</span>
<span class="s2">    }</span>

<span class="s2">    # Make API request for predictions</span>
<span class="s2">    success = False</span>
<span class="s2">    while not success:</span>
<span class="s2">        predictions_response = requests.post(URL, data=data, headers=headers,)</span>
<span class="s2">        # Make sure we are not running into a 429 (too many requests) error</span>
<span class="s2">        if predictions_response.status_code == 429:</span>
<span class="s2">            time.sleep(int(predictions_response.headers[&quot;Retry-After&quot;]))</span>
<span class="s2">        else:</span>
<span class="s2">            success = True</span>
<span class="s2">    # Get response data</span>
<span class="s2">    res = predictions_response.json()[&quot;data&quot;]</span>
<span class="s2">    # Get the prediction for the case where label == 1</span>
<span class="s2">    # NOTE: this is only for binary classification</span>
<span class="s2">    preds = []</span>
<span class="s2">    for pred in res:</span>
<span class="s2">        for val in pred[&quot;predictionValues&quot;]:</span>
<span class="s2">            if val[&quot;label&quot;] == 1:</span>
<span class="s2">                preds.append(val[&quot;value&quot;])</span>
<span class="s2">                break</span>
<span class="s2">        else:</span>
<span class="s2">            raise ValueError(</span>
<span class="s2">                f&quot;No prediction for input row </span><span class="si">{pred[&#39;rowId&#39;]}</span><span class="s2"> and label == 1&quot;</span>
<span class="s2">            )</span>
<span class="s2">    return np.array(preds)</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">file_str</span>


<span class="k">def</span> <span class="nf">upload_model</span><span class="p">(</span>
    <span class="n">deployment</span><span class="p">:</span> <span class="n">dr</span><span class="o">.</span><span class="n">Deployment</span><span class="p">,</span> <span class="n">api_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Upload trained model to RIME cluster and return the resultant model directory path.&quot;&quot;&quot;</span>
    <span class="n">upload_path</span> <span class="o">=</span> <span class="s2">&quot;datarobot_demo&quot;</span>
    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">extras_dir</span> <span class="o">=</span> <span class="n">_dir</span> <span class="o">/</span> <span class="s2">&quot;model_extras&quot;</span>
        <span class="n">extras_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">_dir</span> <span class="o">/</span> <span class="s2">&quot;model.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_model_file_contents</span><span class="p">(</span><span class="n">deployment</span><span class="p">,</span> <span class="n">api_token</span><span class="p">))</span>
        <span class="n">uploaded_path</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">upload_directory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">upload_path</span><span class="o">=</span><span class="n">upload_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uploaded_path</span> <span class="o">+</span> <span class="s2">&quot;/model.py&quot;</span>


<span class="k">def</span> <span class="nf">upload_dataset_file</span><span class="p">(</span><span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">split</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Upload dataframe to RIME cluster.&quot;&quot;&quot;</span>
    <span class="n">upload_path</span> <span class="o">=</span> <span class="s2">&quot;datarobot_demo&quot;</span>
    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">split</span><span class="si">}</span><span class="s2">_data.csv&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">uploaded_name</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span> <span class="n">upload_path</span><span class="o">=</span><span class="n">upload_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uploaded_name</span>


<span class="k">def</span> <span class="nf">prepare_test_config</span><span class="p">(</span>
    <span class="n">rime_ref_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">rime_eval_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">rime_model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">net_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">label_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pred_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare a test config from the given paths.&quot;&quot;&quot;</span>
    <span class="n">test_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">net_name</span><span class="si">}</span><span class="s2"> DataRobot Experiment&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data_info&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;label_col&quot;</span><span class="p">:</span> <span class="n">label_col</span><span class="p">},</span>
        <span class="s2">&quot;model_info&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;model_task&quot;</span><span class="p">:</span> <span class="s2">&quot;Binary Classification&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">pred_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">test_config</span><span class="p">[</span><span class="s2">&quot;data_info&quot;</span><span class="p">][</span><span class="s2">&quot;pred_col&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_col</span>
    <span class="n">test_config</span><span class="p">[</span><span class="s2">&quot;data_info&quot;</span><span class="p">][</span><span class="s2">&quot;ref_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rime_ref_path</span>
    <span class="n">test_config</span><span class="p">[</span><span class="s2">&quot;data_info&quot;</span><span class="p">][</span><span class="s2">&quot;eval_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rime_eval_path</span>
    <span class="n">test_config</span><span class="p">[</span><span class="s2">&quot;model_info&quot;</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rime_model_path</span>
    <span class="k">return</span> <span class="n">test_config</span>


<span class="k">def</span> <span class="nf">run_rime_stress_tests</span><span class="p">(</span>
    <span class="n">test_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">client</span><span class="p">:</span> <span class="n">Client</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">Project</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Job</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the stress tests for RIME.&quot;&quot;&quot;</span>
    <span class="n">stress_test_job</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">start_stress_test</span><span class="p">(</span>
        <span class="n">test_config</span><span class="p">,</span> <span class="n">project_id</span><span class="o">=</span><span class="n">project</span><span class="o">.</span><span class="n">project_id</span>
    <span class="p">)</span>
    <span class="n">stress_test_job_status</span> <span class="o">=</span> <span class="n">stress_test_job</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wait_until_finish</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">stress_test_job_status</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;JOB_STATUS_SUCCEEDED&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stress_test_job</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stress test job run failing. </span><span class="si">{</span><span class="n">stress_test_job_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Upload-Data-+-Model">
<h3><strong>Upload Data + Model</strong><a class="headerlink" href="#Upload-Data-+-Model" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Below, upload data and the model file, then kick off a stress testing run.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net_name</span> <span class="o">=</span> <span class="s2">&quot;Fraud Detection Model&quot;</span>
<span class="n">rime_ref_path</span> <span class="o">=</span> <span class="n">upload_dataset_file</span><span class="p">(</span><span class="n">rime_client</span><span class="p">,</span> <span class="n">train_with_preds</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">)</span>
<span class="n">rime_eval_path</span> <span class="o">=</span> <span class="n">upload_dataset_file</span><span class="p">(</span><span class="n">rime_client</span><span class="p">,</span> <span class="n">test_with_preds</span><span class="p">,</span> <span class="s2">&quot;eval&quot;</span><span class="p">)</span>
<span class="n">rime_model_path</span> <span class="o">=</span> <span class="n">upload_model</span><span class="p">(</span><span class="n">deployment</span><span class="p">,</span> <span class="n">DATAROBOT_TOKEN</span><span class="p">,</span> <span class="n">rime_client</span><span class="p">)</span>
<span class="n">test_config</span> <span class="o">=</span> <span class="n">prepare_test_config</span><span class="p">(</span><span class="n">rime_ref_path</span><span class="p">,</span> <span class="n">rime_eval_path</span><span class="p">,</span> <span class="n">rime_model_path</span><span class="p">,</span> <span class="n">net_name</span><span class="p">,</span> <span class="n">label_col</span><span class="p">,</span> <span class="n">pred_col</span><span class="o">=</span><span class="n">pred_col_name</span><span class="p">)</span>
<span class="n">stress_job</span> <span class="o">=</span> <span class="n">run_rime_stress_tests</span><span class="p">(</span><span class="n">test_config</span><span class="p">,</span> <span class="n">rime_client</span><span class="p">,</span> <span class="n">rime_project</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Stress-Test-Results">
<h2><strong>Stress Test Results</strong><a class="headerlink" href="#Stress-Test-Results" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Stress stest are grouped into categories that measure various aspects of model robustness (model behavior, distribution drift, abnormal input, transformations, adversarial attacks, data cleanliness). Suggestions to improve your model are aggregated on the category level as well. Tests are ranked by default by a shared severity metric. Clicking on an individual test surfaces more detailed information.</p>
<p>You can view the detailed results in the UI by running the below cell and redirecting to the generated link. This page shows granular results for a given AI Stress Test run.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_run</span> <span class="o">=</span> <span class="n">stress_job</span><span class="o">.</span><span class="n">get_test_run</span><span class="p">()</span>
<span class="n">test_run</span>
</pre></div>
</div>
</div>
<section id="Analyzing-the-Results">
<h3><strong>Analyzing the Results</strong><a class="headerlink" href="#Analyzing-the-Results" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Navigate the link printed in the above code block to identify issues with the current model.</p>
</section>
<section id="Programmatically-Querying-the-Results">
<h3><strong>Programmatically Querying the Results</strong><a class="headerlink" href="#Programmatically-Querying-the-Results" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>RIME not only provides you with an intuitive UI to visualize and explore these results, but also allows you to programmatically query these results. This allows you to integrate with any MLOps pipeline, log results to experiment management tools like MLFlow, bring automated decision making to your ML practices, or store these results for future references.</p>
<p>Run the below cell to programmatically query the results. The results are outputed as a pandas dataframe.</p>
<p><strong>Access results at the a test run overview level</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_run_result</span> <span class="o">=</span> <span class="n">test_run</span><span class="o">.</span><span class="n">get_result_df</span><span class="p">()</span>
<span class="n">test_run_result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;Fraud_Test_Run_Results.csv&quot;</span><span class="p">)</span>
<span class="n">test_run_result</span>
</pre></div>
</div>
</div>
<p><strong>Access detailed test results at each individual test cases level.</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_case_result</span> <span class="o">=</span> <span class="n">test_run</span><span class="o">.</span><span class="n">get_test_cases_df</span><span class="p">(</span><span class="n">show_test_case_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">test_case_result</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;Fraud_Test_Case_Results.csv&quot;</span><span class="p">)</span>
<span class="n">test_case_result</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Deploy-to-Production-and-Create-the-AI-Firewall">
<h2><strong>Deploy to Production and Create the AI Firewall</strong><a class="headerlink" href="#Deploy-to-Production-and-Create-the-AI-Firewall" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Once you have identified the best stress test run, you can deploy the associated model wrapped with the AI Firewall. The AI Firewall operates on both a datapoint and batch level. It automatically protects your model in real-time from ‚Äúbad‚Äù incoming data and also alerts on statistically significant distributional drift.</p>
<p>In this scenario, the data scientist is short on time and decided to deploy the existing model to production. The data scientist also creates and wraps a firewall around the model. The AI Firewall is automatically configured based on the failures identified by AI Stress testing to protect the tested model in Production.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">firewall</span> <span class="o">=</span> <span class="n">rime_project</span><span class="o">.</span><span class="n">create_firewall</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;DataRobot Firewall&quot;</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="n">test_run_id</span><span class="o">=</span><span class="n">test_run</span><span class="o">.</span><span class="n">test_run_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Uploading-a-Batch-of-Production-Data-&amp;-Model-Predictions-to-Firewall">
<h2><strong>Uploading a Batch of Production Data &amp; Model Predictions to Firewall</strong><a class="headerlink" href="#Uploading-a-Batch-of-Production-Data-&-Model-Predictions-to-Firewall" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The fraud detection model has been in production for 30 days. Production data and model predictions have been collected and stored for the past 30 days. Now, we will use Firewall to track how the model performed across the last 30 days.</p>
<p><strong>Upload an Incremental Batch of Data</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fetch the production data</span>
<span class="n">TIMESTAMP_COL</span> <span class="o">=</span> <span class="s2">&quot;timestamp&quot;</span>
<span class="n">incremental_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">incremental_file</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">excluded_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Group by week to simulate running weekly batches</span>
<span class="c1"># This isn&#39;t a requirement, as RIME can perform the grouping itself</span>
<span class="n">timestamps_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">(</span><span class="n">incremental_df</span><span class="p">[</span><span class="n">TIMESTAMP_COL</span><span class="p">])</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">incremental_df</span><span class="p">[</span><span class="n">TIMESTAMP_COL</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">timestamps_dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;W-SUN&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()):</span>
    <span class="n">split_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running batch for week </span><span class="si">{</span><span class="n">split_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">batch_df</span> <span class="o">=</span> <span class="n">incremental_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="c1"># Upload to datarobot to make predictions. In a real deployment,</span>
    <span class="c1"># this step would have been done already</span>
    <span class="n">prod_dr_dataset</span> <span class="o">=</span> <span class="n">dr_project</span><span class="o">.</span><span class="n">upload_dataset</span><span class="p">(</span><span class="n">batch_df</span><span class="p">)</span>
    <span class="n">predict_job</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">request_predictions</span><span class="p">(</span><span class="n">prod_dr_dataset</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predict_job</span><span class="o">.</span><span class="n">get_result_when_complete</span><span class="p">()</span>
    <span class="n">batch_df</span><span class="p">[</span><span class="n">pred_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="s1">&#39;positive_probability&#39;</span><span class="p">]</span>
    <span class="c1"># Upload production data with preds to the RIME cluster</span>
    <span class="n">rime_incremental_path</span> <span class="o">=</span> <span class="n">upload_dataset_file</span><span class="p">(</span><span class="n">rime_client</span><span class="p">,</span> <span class="n">batch_df</span><span class="p">,</span> <span class="n">split_name</span><span class="p">)</span>
    <span class="n">incremental_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;eval_path&quot;</span><span class="p">:</span> <span class="n">rime_incremental_path</span><span class="p">,</span>
        <span class="s2">&quot;timestamp_col&quot;</span><span class="p">:</span> <span class="n">TIMESTAMP_COL</span>
    <span class="p">}</span>
    <span class="n">ct_job</span> <span class="o">=</span> <span class="n">firewall</span><span class="o">.</span><span class="n">start_continuous_test</span><span class="p">(</span><span class="n">test_run_config</span><span class="o">=</span><span class="n">incremental_config</span><span class="p">,</span> <span class="n">disable_firewall_events</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ct_job</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wait_until_finish</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p><strong>Wait for a couple minutes and your results will appear in the UI.</strong></p>
</section>
<section id="Firewall-Overview">
<h2><strong>Firewall Overview</strong><a class="headerlink" href="#Firewall-Overview" title="Permalink to this heading">ÔÉÅ</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">firewall</span>
</pre></div>
</div>
</div>
<p>The Overview page is the mission control for your model‚Äôs production deployment health. In it, you can see the status of firewall events, get notified when model performance degrades, and see the underlying causes of failure.</p>
</section>
<section id="Firewall-CT-Results">
<h2><strong>Firewall CT Results</strong><a class="headerlink" href="#Firewall-CT-Results" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The AI Firewall‚Äôs Continuous Tests operate at the batch level and provide a mechanism to monitor the health of ML deployments in production. They allow the user to understand when errors begin to occur and surface the underlying drivers of such errors.</p>
<p>You can explore the results in the UI by running the below cell and redirecting to the generated link.</p>
<section id="Analyzing-CT-Results">
<h3><strong>Analyzing CT Results</strong><a class="headerlink" href="#Analyzing-CT-Results" title="Permalink to this heading">ÔÉÅ</a></h3>
<p>Navigate to the ‚ÄúContinuous Tests‚Äù tab to explore various test metrics over the past month. This view captures some important insights, such as:</p>
<ul class="simple">
<li><p><strong>Abnormality rate increases</strong> - By changing the ‚ÄúMetric‚Äù to ‚ÄúAbnormality Rate‚Äù, we can see that very few abnormal inputs are seen at the outset of the month. By month‚Äôs end, the abnormality rate has shot up to 28.6%</p></li>
<li><p><strong>Prediction Percentiles dropped over time</strong> - By changing the metric to ‚ÄúPrediciton Percentiels‚Äù, we can see that the 50% at the beginning of the month was 0.7, but it dropped to 0.538 by month‚Äôs end.</p></li>
<li><p><strong>Prediction drift increases over time</strong> When evaluating the Prediction Drift, we can see it has increased over time. On 08/01, when the model was deployed, PSI was 0.54. By 08/29, PSI had increased to 2.17.</p></li>
</ul>
</section>
</section>
<section id="Firewall-Realtime-Events-Results">
<h2><strong>Firewall Realtime Events Results</strong><a class="headerlink" href="#Firewall-Realtime-Events-Results" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>The AI Firewall‚Äôs Realtime Events tab operates at the datapoint-level to simultaneously alert and protect your model against issues in real-time. It tracks and surfaces the datapoints that were flagged when entering the AI system.</p>
<p>We can see that for the flagged datapoints in the latest time bucket, the ‚Äúbrowser_version‚Äù feature is failing. We may dig in further by clicking on a flagged row to see the reason it was flagged. In this case, there was a new feature value for ‚Äúbrowser_version‚Äù that the model had not encountered during the model development phase.</p>
</section>
<section id="What's-Next?">
<h2><strong>What‚Äôs Next?</strong><a class="headerlink" href="#What's-Next?" title="Permalink to this heading">ÔÉÅ</a></h2>
<p>Try RIME on your own data and models. You can use <a class="reference external" href="https://colab.research.google.com/drive/1kiFMTcNpmWkr00PhhS0E1bbOBwTlCWXr?usp=sharing#scrollTo=Zm8wT42kwhT0">this tutorial</a> to help you started!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../testing_and_monitoring/integrating_mlops/platform/datarobot.html" class="btn btn-neutral float-left" title="Robust Intelligence ü§ù DataRobot" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="RIME_HuggingFace_Integration_Walkthrough.html" class="btn btn-neutral float-right" title="Robust Intelligence ü§ù ü§ó Integration Walkthrough" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Robust Intelligence.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>