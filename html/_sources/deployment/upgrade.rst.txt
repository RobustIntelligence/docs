Upgrade
===============================

1. Point your local ``kubectl`` to your data plane K8s cluster and namespace.
2. Save the current Helm values to a file:

   .. code-block::

      helm get values rime-agent | awk '!/USER-SUPPLIED VALUES/' > values.yaml

3. Edit the ``values.yaml`` file by changing the image version in the fields ``rimeAgent.images.agentImage.name`` and ``rimeAgent.images.agentImage.name`` to the new version. To find the version value, navigate to **Organization Settings** page, and click on the **Manage Agent Setup** tab. The Control Plane version will be displayed at the top of the pane. The version value to be used in the ``values.yaml`` file will be the Control Plane version without the prefix ``v``.
4. Follow the version specific upgrades.

Upgrading from v2.1 to v2.2
---------------------------------------
1. Update helm chart:

   .. code-block::

      helm repo update
      helm upgrade rime-agent robustintelligence/rime-agent --version $RI_VERSION --values ./values.yaml

Upgrading from v2.0 to v2.1
---------------------------------------
1. Navigate to **Orgainzation Settings** page, and click on the **Manage Agent Setup** tab. Deactivate and delete the agent.
2. Uninstall the agent in your environment:

   .. code-block::

      helm uninstall rime-agent

3. Create the new agent using the create agent button on the **Manage Agent Setup** page. Select the agent type and follow the instructions. If permission related inputs are needed, you can find the same inputs you used in v2.0 in the ``values.yaml`` file under the ``rimeAgent.operator.modelTestJob`` section.

Verify Upgrade
---------------------------------------
1. Verify that the ``rime-agent`` helm chart is of the new version:

   .. code-block::

      helm list

2. Verify docker image versions:

   .. code-block::

      kubectl describe deployment rime-agent-launcher | grep Image

3. Verify that the CRDs ``crossplanerpcjobs.rbst.io`` and ``rimejobs.rbst.io`` are present:

   .. code-block::

      kubectl get crd | grep rbst
