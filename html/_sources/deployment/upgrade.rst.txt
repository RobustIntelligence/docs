Upgrade
===============================

1. Point your local ``kubectl`` to your data plane K8s cluster and namespace.
2. Save the current Helm values to a file:

   .. code-block::

      helm get values rime-agent | awk '!/USER-SUPPLIED VALUES/' > values.yaml

3. Edit the ``values.yaml`` file by changing the image version in the fields ``rimeAgent.images.agentImage.name`` and ``rimeAgent.images.agentImage.name`` to the new version. To find the version value, navigate to **Organization Settings** page, and click on the **Manage Agent Setup** tab. The Control Plane version will be displayed at the top of the pane. The version value to be used in the ``values.yaml`` file will be the Control Plane version without the prefix ``v``.
4. Follow the version specific upgrades.

Upgrading from v2.0 to v2.1
---------------------------------------
1. Update cloud provider's IAM setting used for accessing Datasets and Models to support providing permission for the service account ``rime-agent-rime-cross-plane-server``.
2. In the ``values.yaml`` file, create the section ``rimeAgent.rimeCrossPlaneServer`` with the same IAM related annotations, and in some cases also labels, as the ``rimeAgent.operator.modelTestJob`` section.
3. Update helm chart:

   .. code-block::

      helm uninstall rime-agent
      helm repo update
      helm install rime-agent robustintelligence/rime-agent --version $RI_VERSION --values ./values.yaml


Verify Upgrade
---------------------------------------
1. Verify that the ``rime-agent`` helm chart is of the new version:

   .. code-block::

      helm list

2. Verify docker image versions:

   .. code-block::

      kubectl describe deployment rime-agent-launcher | grep Image

3. Verify that the CRDs ``crossplanerpcjobs.rbst.io`` and ``rimejobs.rbst.io`` are present:

   .. code-block::

      kubectl get crd | grep rbst
